<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' https://js.stripe.com https://www.gstatic.com; frame-src https://js.stripe.com https://hooks.stripe.com; connect-src 'self' https://api.stripe.com https://api.ipify.org https://firestore.googleapis.com;">
    <title>All Seasons Sprouts - Premium Kids & Women's Fashion</title>
    <meta name="description" content="Luxury kids and women's fashion retailer featuring designer clothing, accessories, and jewelry for discerning families.">
    <meta property="og:title" content="All Seasons Sprouts - Premium Fashion">
    <meta property="og:description" content="Discover luxury kids and women's fashion collections">
    <meta property="og:type" content="website">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Profile System Styles */
        .profile-btn-header {
            background: none;
            border: none;
            cursor: pointer;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .profile-btn-header:hover {
            background: #f3f4f6;
        }

        .wishlist-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0;
        }

        .product-card:hover .wishlist-btn {
            opacity: 1;
        }

        .wishlist-btn:hover {
            background: #2d5a27;
            color: white;
        }

        .product-image-container {
            position: relative;
        }

        /* Profile Modal Base Styles */
        .profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .profile-modal.show {
            display: flex;
        }

        .signup-prompt-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1100;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .signup-prompt-modal.show {
            display: flex;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-content">
            <div class="loading-logo">All Seasons Sprouts</div>
            <div class="loading-line"></div>
        </div>
    </div>

    <!-- Header -->
    <header class="header" id="header">
        <nav class="nav-container">
            <a href="#" class="logo">All Seasons Sprouts</a>
            
            <ul class="nav-menu" id="navMenu">
                <li><a href="#home">Home</a></li>
                <li><a href="#collections">Collections</a></li>
                <li><a href="#boys">Boys</a></li>
                <li><a href="#girls">Girls</a></li>
                <li><a href="#women">Women</a></li>
                <li><a href="#contact">Contact</a></li>
            </ul>
            
            <div class="header-actions">
                <button class="search-btn" aria-label="Search">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                </button>

                <!-- Profile Button -->
                <button class="profile-btn-header" id="profileBtn" aria-label="User Profile">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </button>
                
                <button class="cart-btn" id="cartBtn" aria-label="Shopping Cart">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 22C9.55228 22 10 21.5523 10 21C10 20.4477 9.55228 20 9 20C8.44772 20 8 20.4477 8 21C8 21.5523 8.44772 22 9 22Z"></path>
                        <path d="M20 22C20.5523 22 21 21.5523 21 21C21 20.4477 20.5523 20 20 20C19.4477 20 19 20.4477 19 21C19 21.5523 19.4477 22 20 22Z"></path>
                        <path d="M1 1H5L7.68 14.39C7.77144 14.8504 8.02191 15.264 8.38755 15.5583C8.75318 15.8526 9.2107 16.009 9.68 16H19.4C19.8693 16.009 20.3268 15.8526 20.6925 15.5583C21.0581 15.264 21.3086 14.8504 21.4 14.39L23 6H6"></path>
                    </svg>
                    <span class="cart-count" id="cartCount">0</span>
                </button>
                
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </nav>
    </header>

    <!-- Hero Section -->
    <section class="hero" id="home">
        <div class="hero-content">
            <p class="hero-subtitle">Premium Fashion</p>
            <h1 class="hero-title">All Seasons Sprouts</h1>
            <p class="hero-description">Curated collections of luxury kids and women's fashion, designed for the modern family with discerning taste.</p>
            <a href="#collections" class="hero-cta">
                <span>Explore Collection</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M5 12h14M12 5l7 7-7 7"/>
                </svg>
            </a>
        </div>
    </section>

    <!-- Collections Section -->
    <section class="collections-section" id="collections">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title">Our Collections</h2>
                <p class="section-subtitle">Discover meticulously curated pieces for every season</p>
            </div>
            
            <div class="filter-tabs">
                <button class="filter-tab active" data-filter="all">All</button>
                <button class="filter-tab" data-filter="boys">Boys</button>
                <button class="filter-tab" data-filter="girls">Girls</button>
                <button class="filter-tab" data-filter="women">Women</button>
                <button class="filter-tab" data-filter="accessories">Accessories</button>
            </div>
            
            <div class="products-grid" id="productsGrid">
                <!-- Products will be loaded here -->
            </div>
        </div>
    </section>

    <!-- Cart Sidebar -->
    <div class="cart-sidebar" id="cartSidebar">
        <div class="cart-header">
            <h3 class="cart-title">Shopping Cart</h3>
            <button class="cart-close" id="cartClose" aria-label="Close Cart">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        
        <div class="cart-items" id="cartItems">
            <div class="empty-cart">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                    <path d="M9 22C9.55228 22 10 21.5523 10 21C10 20.4477 9.55228 20 9 20C8.44772 20 8 20.4477 8 21C8 21.5523 8.44772 22 9 22Z"></path>
                    <path d="M20 22C20.5523 22 21 21.5523 21 21C21 20.4477 20.5523 20 20 20C19.4477 20 19 20.4477 19 21C19 21.5523 19.4477 22 20 22Z"></path>
                    <path d="M1 1H5L7.68 14.39C7.77144 14.8504 8.02191 15.264 8.38755 15.5583C8.75318 15.8526 9.2107 16.009 9.68 16H19.4C19.8693 16.009 20.3268 15.8526 20.6925 15.5583C21.0581 15.264 21.3086 14.8504 21.4 14.39L23 6H6"></path>
                </svg>
                <h4>Your cart is empty</h4>
                <p>Add some beautiful pieces to get started</p>
            </div>
        </div>
        
        <div class="cart-footer">
            <div class="cart-total">
                <span>Total</span>
                <span id="cartTotal">$0.00</span>
            </div>
            <button class="checkout-btn" id="checkoutBtn" disabled>
                Proceed to Checkout
            </button>
        </div>
    </div>

    <!-- Cart Overlay -->
    <div class="cart-overlay" id="cartOverlay"></div>

    <!-- Profile Modal Container -->
    <div id="profileModalContainer">
        <!-- Profile Modal content will be injected here -->
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <div class="notification-content">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20,6 9,17 4,12"></polyline>
            </svg>
            <span id="notificationText">Item added to cart</span>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>All Seasons Sprouts</h3>
                    <p>Luxury kids and women's fashion retailer committed to exceptional quality, timeless style, and sustainable practices.</p>
                    <div class="contact-info">
                        <p>Email: <a href="mailto:maezron54@gmail.com">maezron54@gmail.com</a></p>
                    </div>
                </div>
                
                <div class="footer-section">
                    <h3>Collections</h3>
                    <ul>
                        <li><a href="#boys">Boys Clothing</a></li>
                        <li><a href="#girls">Girls Clothing</a></li>
                        <li><a href="#women">Women's Jewelry</a></li>
                        <li><a href="#accessories">Accessories</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h3>Customer Care</h3>
                    <ul>
                        <li><a href="#contact">Contact Us</a></li>
                        <li><a href="#shipping">Shipping & Returns</a></li>
                        <li><a href="#size-guide">Size Guide</a></li>
                        <li><a href="#care">Care Instructions</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h3>Connect</h3>
                    <ul>
                        <li><a href="#instagram">Instagram</a></li>
                        <li><a href="#newsletter">Newsletter</a></li>
                        <li><a href="#about">Our Story</a></li>
                        <li><a href="#sustainability">Sustainability</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>&copy; 2024 All Seasons Sprouts. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Firebase Scripts - Load in correct order -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<!-- <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script> -->
    
    <!-- Application Scripts - Load in correct order -->
    <script src="firebase-config.js"></script>
    <script>
        // Profile Manager Classes
        
        // Base Profile Manager Interface
        class BaseProfileManager {
            constructor() {
                this.currentProfile = null;
            }

            generateProfileId() {
                return 'profile_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            generateSessionId() {
                let sessionId = sessionStorage.getItem('session_id');
                if (!sessionId) {
                    sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    sessionStorage.setItem('session_id', sessionId);
                }
                return sessionId;
            }

            createBaseProfile(profileId, profileType = 'guest') {
                return {
                    id: profileId,
                    type: profileType,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString(),
                    session_id: this.generateSessionId(),
                    
                    personal_info: {
                        email: null,
                        name: null,
                        phone: null,
                        addresses: []
                    },
                    
                    shopping: {
                        cart: {
                            items: [],
                            total: 0,
                            updated_at: null
                        },
                        wishlist: [],
                        purchase_history: [],
                        abandoned_carts: []
                    },
                    
                    browsing: {
                        page_views: [],
                        product_views: [],
                        categories_visited: [],
                        search_queries: [],
                        time_spent: 0,
                        last_active: new Date().toISOString()
                    },
                    
                    analytics: {
                        events: [],
                        filters_used: [],
                        actions_taken: []
                    },
                    
                    preferences: {
                        currency: 'USD',
                        notifications: true,
                        marketing_emails: false,
                        size_preferences: {},
                        favorite_categories: []
                    },
                    
                    metadata: {
                        user_agent: navigator.userAgent,
                        screen_resolution: screen.width + 'x' + screen.height,
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                        language: navigator.language,
                        referrer: document.referrer || 'direct',
                        first_visit: new Date().toISOString(),
                        visit_count: 1
                    }
                };
            }
        }

        // Firebase Profile Manager
        class FirebaseProfileManager extends BaseProfileManager {
            constructor(db, auth) {
                super();
                this.db = db;
                this.auth = auth;
                this.profilesCollection = 'user_profiles';
                this.batchUpdateScheduled = false;
            }

            async initializeProfile() {
                try {
                    const user = this.auth.currentUser;
                    
                    if (user) {
                        this.currentProfile = await this.loadRegisteredProfile(user);
                    } else {
                        this.currentProfile = await this.loadGuestProfile();
                    }
                    
                    return this.currentProfile;
                } catch (error) {
                    console.error('Failed to initialize profile:', error);
                    this.currentProfile = this.createFallbackProfile();
                    return this.currentProfile;
                }
            }

            async loadGuestProfile() {
                try {
                    const sessionId = this.generateSessionId();
                    const guestProfileKey = 'guest_profile_' + sessionId;
                    
                    const localProfile = localStorage.getItem(guestProfileKey);
                    if (localProfile) {
                        const profile = JSON.parse(localProfile);
                        
                        try {
                            await this.syncGuestProfileToFirebase(profile);
                        } catch (error) {
                            console.warn('Failed to sync guest profile to Firebase:', error);
                        }
                        
                        return profile;
                    }
                    
                    const profileId = 'guest_' + sessionId;
                    const profile = this.createBaseProfile(profileId, 'guest');
                    
                    localStorage.setItem(guestProfileKey, JSON.stringify(profile));
                    
                    try {
                        await this.db.collection(this.profilesCollection).doc(profileId).set(profile);
                    } catch (error) {
                        console.warn('Failed to save guest profile to Firebase:', error);
                    }
                    
                    return profile;
                } catch (error) {
                    console.error('Failed to load guest profile:', error);
                    return this.createFallbackProfile();
                }
            }

            async syncGuestProfileToFirebase(profile) {
                if (!this.db) return;
                
                try {
                    await this.db.collection(this.profilesCollection).doc(profile.id).set(profile, { merge: true });
                } catch (error) {
                    console.warn('Failed to sync guest profile to Firebase:', error);
                }
            }

            async getCurrentProfile() {
                return this.currentProfile;
            }

            async updateProfile(updates) {
                if (!this.currentProfile) return null;
                
                try {
                    Object.assign(this.currentProfile.personal_info, updates.personal_info || {});
                    Object.assign(this.currentProfile.preferences, updates.preferences || {});
                    this.currentProfile.updated_at = new Date().toISOString();
                    
                    if (this.db) {
                        await this.db.collection(this.profilesCollection).doc(this.currentProfile.id).update({
                            personal_info: this.currentProfile.personal_info,
                            preferences: this.currentProfile.preferences,
                            updated_at: this.currentProfile.updated_at
                        });
                    }
                    
                    if (this.currentProfile.type === 'guest') {
                        const sessionId = this.generateSessionId();
                        const guestProfileKey = 'guest_profile_' + sessionId;
                        localStorage.setItem(guestProfileKey, JSON.stringify(this.currentProfile));
                    }
                    
                    return this.currentProfile;
                } catch (error) {
                    console.error('Failed to update profile:', error);
                    throw error;
                }
            }

            async trackAction(action, data = {}) {
                if (!this.currentProfile) return;
                
                try {
                    const event = {
                        action,
                        data,
                        timestamp: new Date().toISOString(),
                        page_url: window.location.href,
                        user_agent: navigator.userAgent
                    };
                    
                    this.currentProfile.analytics.events.push(event);
                    this.currentProfile.browsing.last_active = new Date().toISOString();
                    this.currentProfile.updated_at = new Date().toISOString();
                    
                    if (this.currentProfile.analytics.events.length > 1000) {
                        this.currentProfile.analytics.events = this.currentProfile.analytics.events.slice(-1000);
                    }
                    
                    await this.batchUpdateProfile();
                    
                } catch (error) {
                    console.error('Failed to track action:', error);
                }
            }

            async addToCart(productId, quantity = 1) {
                if (!this.currentProfile) return;
                
                const existingItem = this.currentProfile.shopping.cart.items.find(item => item.product_id === productId);
                
                if (existingItem) {
                    existingItem.quantity += quantity;
                    existingItem.updated_at = new Date().toISOString();
                } else {
                    this.currentProfile.shopping.cart.items.push({
                        product_id: productId,
                        quantity,
                        added_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    });
                }
                
                await this.updateCartTotal();
                await this.batchUpdateProfile();
            }

            async removeFromCart(productId) {
                if (!this.currentProfile) return;
                
                this.currentProfile.shopping.cart.items = this.currentProfile.shopping.cart.items.filter(
                    item => item.product_id !== productId
                );
                
                await this.updateCartTotal();
                await this.batchUpdateProfile();
            }

            async updateCartQuantity(productId, quantity) {
                if (!this.currentProfile) return;
                
                const item = this.currentProfile.shopping.cart.items.find(item => item.product_id === productId);
                if (item) {
                    if (quantity <= 0) {
                        await this.removeFromCart(productId);
                    } else {
                        item.quantity = quantity;
                        item.updated_at = new Date().toISOString();
                        await this.updateCartTotal();
                        await this.batchUpdateProfile();
                    }
                }
            }

            async clearCart() {
                if (!this.currentProfile) return;
                
                if (this.currentProfile.shopping.cart.items.length > 0) {
                    this.currentProfile.shopping.abandoned_carts.push({
                        ...this.currentProfile.shopping.cart,
                        abandoned_at: new Date().toISOString()
                    });
                    
                    if (this.currentProfile.shopping.abandoned_carts.length > 10) {
                        this.currentProfile.shopping.abandoned_carts = this.currentProfile.shopping.abandoned_carts.slice(-10);
                    }
                }
                
                this.currentProfile.shopping.cart = {
                    items: [],
                    total: 0,
                    updated_at: new Date().toISOString()
                };
                
                await this.batchUpdateProfile();
            }

            async addToWishlist(productId, productData = {}) {
                if (!this.currentProfile) return;
                
                const existingItem = this.currentProfile.shopping.wishlist.find(item => item.product_id === productId);
                if (!existingItem) {
                    this.currentProfile.shopping.wishlist.push({
                        product_id: productId,
                        product_data: productData,
                        added_at: new Date().toISOString()
                    });
                    
                    await this.batchUpdateProfile();
                }
            }

            async removeFromWishlist(productId) {
                if (!this.currentProfile) return;
                
                this.currentProfile.shopping.wishlist = this.currentProfile.shopping.wishlist.filter(
                    item => item.product_id !== productId
                );
                
                await this.batchUpdateProfile();
            }

            async addPurchase(orderData) {
                if (!this.currentProfile) return;
                
                const purchase = {
                    ...orderData,
                    purchased_at: new Date().toISOString()
                };
                
                this.currentProfile.shopping.purchase_history.push(purchase);
                await this.clearCart();
                await this.batchUpdateProfile();
            }

            async trackPageView(pageName, data = {}) {
                if (!this.currentProfile) return;
                
                const pageView = {
                    page: pageName,
                    data,
                    timestamp: new Date().toISOString(),
                    url: window.location.href
                };
                
                this.currentProfile.browsing.page_views.push(pageView);
                this.currentProfile.browsing.last_active = new Date().toISOString();
                
                if (this.currentProfile.browsing.page_views.length > 500) {
                    this.currentProfile.browsing.page_views = this.currentProfile.browsing.page_views.slice(-500);
                }
                
                await this.batchUpdateProfile();
            }

            async trackProductView(productId, productData = {}) {
                if (!this.currentProfile) return;
                
                const productView = {
                    product_id: productId,
                    product_data: productData,
                    timestamp: new Date().toISOString()
                };
                
                this.currentProfile.browsing.product_views.push(productView);
                
                if (this.currentProfile.browsing.product_views.length > 100) {
                    this.currentProfile.browsing.product_views = this.currentProfile.browsing.product_views.slice(-100);
                }
                
                await this.batchUpdateProfile();
            }

            async updateCartTotal() {
                if (!this.currentProfile || typeof products === 'undefined') return;
                
                let total = 0;
                this.currentProfile.shopping.cart.items.forEach(item => {
                    const product = products.find(p => p.id === item.product_id);
                    if (product) {
                        total += product.price * item.quantity;
                    }
                });
                
                this.currentProfile.shopping.cart.total = total;
                this.currentProfile.shopping.cart.updated_at = new Date().toISOString();
            }

            async batchUpdateProfile() {
                if (this.batchUpdateScheduled) return;
                
                this.batchUpdateScheduled = true;
                
                setTimeout(async () => {
                    try {
                        if (this.db && this.currentProfile) {
                            await this.db.collection(this.profilesCollection).doc(this.currentProfile.id).set(this.currentProfile, { merge: true });
                        }
                        
                        if (this.currentProfile?.type === 'guest') {
                            const sessionId = this.generateSessionId();
                            const guestProfileKey = 'guest_profile_' + sessionId;
                            localStorage.setItem(guestProfileKey, JSON.stringify(this.currentProfile));
                        }
                    } catch (error) {
                        console.warn('Failed to batch update profile:', error);
                    } finally {
                        this.batchUpdateScheduled = false;
                    }
                }, 2000);
            }

            createFallbackProfile() {
                const profileId = 'fallback_' + Date.now();
                return this.createBaseProfile(profileId, 'guest');
            }

            async handleAuthChange(user) {
                console.log('Auth change detected:', user ? 'authenticated' : 'anonymous');
            }
        }

        // Offline Profile Manager
        class OfflineProfileManager extends BaseProfileManager {
            constructor() {
                super();
                this.storageKey = 'offline_profile';
            }

            async initializeProfile() {
                try {
                    const storedProfile = localStorage.getItem(this.storageKey);
                    
                    if (storedProfile) {
                        this.currentProfile = JSON.parse(storedProfile);
                        this.currentProfile.metadata.visit_count += 1;
                        this.currentProfile.browsing.last_active = new Date().toISOString();
                        this.currentProfile.updated_at = new Date().toISOString();
                        await this.saveProfile();
                    } else {
                        const profileId = this.generateProfileId();
                        this.currentProfile = this.createBaseProfile(profileId, 'guest');
                        await this.saveProfile();
                    }
                    
                    return this.currentProfile;
                } catch (error) {
                    console.error('Failed to initialize offline profile:', error);
                    const profileId = this.generateProfileId();
                    this.currentProfile = this.createBaseProfile(profileId, 'guest');
                    return this.currentProfile;
                }
            }

            async getCurrentProfile() {
                return this.currentProfile;
            }

            async updateProfile(updates) {
                if (!this.currentProfile) return null;
                
                Object.assign(this.currentProfile.personal_info, updates.personal_info || {});
                Object.assign(this.currentProfile.preferences, updates.preferences || {});
                this.currentProfile.updated_at = new Date().toISOString();
                
                await this.saveProfile();
                return this.currentProfile;
            }

            async trackAction(action, data = {}) {
                if (!this.currentProfile) return;
                
                const event = {
                    action,
                    data,
                    timestamp: new Date().toISOString(),
                    page_url: window.location.href,
                    user_agent: navigator.userAgent
                };
                
                this.currentProfile.analytics.events.push(event);
                this.currentProfile.browsing.last_active = new Date().toISOString();
                this.currentProfile.updated_at = new Date().toISOString();
                
                if (this.currentProfile.analytics.events.length > 1000) {
                    this.currentProfile.analytics.events = this.currentProfile.analytics.events.slice(-1000);
                }
                
                await this.saveProfile();
            }

            async addToCart(productId, quantity = 1) {
                if (!this.currentProfile) return;
                
                const existingItem = this.currentProfile.shopping.cart.items.find(item => item.product_id === productId);
                
                if (existingItem) {
                    existingItem.quantity += quantity;
                    existingItem.updated_at = new Date().toISOString();
                } else {
                    this.currentProfile.shopping.cart.items.push({
                        product_id: productId,
                        quantity,
                        added_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    });
                }
                
                await this.updateCartTotal();
                await this.saveProfile();
            }

            async removeFromCart(productId) {
                if (!this.currentProfile) return;
                this.currentProfile.shopping.cart.items = this.currentProfile.shopping.cart.items.filter(item => item.product_id !== productId);
                await this.updateCartTotal();
                await this.saveProfile();
            }

            async updateCartQuantity(productId, quantity) {
                if (!this.currentProfile) return;
                const item = this.currentProfile.shopping.cart.items.find(item => item.product_id === productId);
                if (item) {
                    if (quantity <= 0) {
                        await this.removeFromCart(productId);
                    } else {
                        item.quantity = quantity;
                        item.updated_at = new Date().toISOString();
                        await this.updateCartTotal();
                        await this.saveProfile();
                    }
                }
            }

            async clearCart() {
                if (!this.currentProfile) return;
                if (this.currentProfile.shopping.cart.items.length > 0) {
                    this.currentProfile.shopping.abandoned_carts.push({
                        ...this.currentProfile.shopping.cart,
                        abandoned_at: new Date().toISOString()
                    });
                    if (this.currentProfile.shopping.abandoned_carts.length > 10) {
                        this.currentProfile.shopping.abandoned_carts = this.currentProfile.shopping.abandoned_carts.slice(-10);
                    }
                }
                this.currentProfile.shopping.cart = { items: [], total: 0, updated_at: new Date().toISOString() };
                await this.saveProfile();
            }

            async addToWishlist(productId, productData = {}) {
                if (!this.currentProfile) return;
                const existingItem = this.currentProfile.shopping.wishlist.find(item => item.product_id === productId);
                if (!existingItem) {
                    this.currentProfile.shopping.wishlist.push({
                        product_id: productId,
                        product_data: productData,
                        added_at: new Date().toISOString()
                    });
                    await this.saveProfile();
                }
            }

            async removeFromWishlist(productId) {
                if (!this.currentProfile) return;
                this.currentProfile.shopping.wishlist = this.currentProfile.shopping.wishlist.filter(item => item.product_id !== productId);
                await this.saveProfile();
            }

            async addPurchase(orderData) {
                if (!this.currentProfile) return;
                const purchase = { ...orderData, purchased_at: new Date().toISOString() };
                this.currentProfile.shopping.purchase_history.push(purchase);
                await this.clearCart();
                await this.saveProfile();
            }

            async trackPageView(pageName, data = {}) {
                if (!this.currentProfile) return;
                const pageView = { page: pageName, data, timestamp: new Date().toISOString(), url: window.location.href };
                this.currentProfile.browsing.page_views.push(pageView);
                this.currentProfile.browsing.last_active = new Date().toISOString();
                if (this.currentProfile.browsing.page_views.length > 500) {
                    this.currentProfile.browsing.page_views = this.currentProfile.browsing.page_views.slice(-500);
                }
                await this.saveProfile();
            }

            async trackProductView(productId, productData = {}) {
                if (!this.currentProfile) return;
                const productView = { product_id: productId, product_data: productData, timestamp: new Date().toISOString() };
                this.currentProfile.browsing.product_views.push(productView);
                if (this.currentProfile.browsing.product_views.length > 100) {
                    this.currentProfile.browsing.product_views = this.currentProfile.browsing.product_views.slice(-100);
                }
                await this.saveProfile();
            }

            async updateCartTotal() {
                if (!this.currentProfile || typeof products === 'undefined') return;
                let total = 0;
                this.currentProfile.shopping.cart.items.forEach(item => {
                    const product = products.find(p => p.id === item.product_id);
                    if (product) total += product.price * item.quantity;
                });
                this.currentProfile.shopping.cart.total = total;
                this.currentProfile.shopping.cart.updated_at = new Date().toISOString();
            }

            async saveProfile() {
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(this.currentProfile));
                } catch (error) {
                    console.error('Failed to save profile to localStorage:', error);
                }
            }

            async handleAuthChange(user) {
                console.log('Auth change detected in offline mode - profile will remain local');
            }
        }

        // ===== ENHANCED PROFILE UI COMPONENT =====

class ProfileUI {
    constructor() {
        this.firebaseManager = null;
        this.currentProfile = null;
        this.modalContainer = null;
        this.isInitialized = false;
    }

    initialize(firebaseManager) {
        this.firebaseManager = firebaseManager;
        this.setupModalContainer();
        this.setupEventListeners();
        this.loadProfile();
        this.isInitialized = true;
        console.log('ProfileUI initialized');
    }

    setupModalContainer() {
        // Create modal container if it doesn't exist
        this.modalContainer = document.getElementById('profileModalContainer');
        if (!this.modalContainer) {
            this.modalContainer = document.createElement('div');
            this.modalContainer.id = 'profileModalContainer';
            document.body.appendChild(this.modalContainer);
        }
    }

    setupEventListeners() {
        const profileBtn = document.getElementById('profileBtn');
        if (profileBtn) {
            profileBtn.addEventListener('click', (e) => {
                e.preventDefault();
                this.showProfileModal();
            });
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                this.closeAllModals();
            }
        });
    }

    async loadProfile() {
        if (!this.firebaseManager) return;
        
        try {
            this.currentProfile = await this.firebaseManager.getCurrentProfile();
            this.updateProfileButton();
        } catch (error) {
            console.error('Failed to load profile:', error);
        }
    }

    updateProfileButton() {
        const profileBtn = document.getElementById('profileBtn');
        if (!profileBtn || !this.currentProfile) return;

        const isGuest = this.currentProfile.type === 'guest';
        const cartItems = this.currentProfile.shopping?.cart?.items?.length || 0;
        
        // Add visual indicator for guest users with items
        if (isGuest && cartItems > 0) {
            profileBtn.style.position = 'relative';
            let indicator = profileBtn.querySelector('.guest-indicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.className = 'guest-indicator';
                indicator.style.cssText = `
                    position: absolute;
                    top: -2px;
                    right: -2px;
                    width: 8px;
                    height: 8px;
                    background: #f59e0b;
                    border-radius: 50%;
                    border: 2px solid white;
                `;
                profileBtn.appendChild(indicator);
            }
        }
    }

    showProfileModal() {
        if (!this.currentProfile) {
            alert('Profile not loaded yet. Please try again.');
            return;
        }

        const modal = this.createProfileModal();
        this.modalContainer.innerHTML = '';
        this.modalContainer.appendChild(modal);
        
        // Show modal with animation
        setTimeout(() => {
            modal.classList.add('show');
        }, 10);

        // Track modal view
        if (this.firebaseManager) {
            this.firebaseManager.logEvent('profile_modal_opened', {
                profile_type: this.currentProfile.type
            });
        }
    }

    createProfileModal() {
        const modal = document.createElement('div');
        modal.className = 'profile-modal';
        modal.id = 'profileModal';
        
        const stats = this.calculateStats();
        const isGuest = this.currentProfile.type === 'guest';
        
        modal.innerHTML = `
            <div class="profile-modal-content" onclick="event.stopPropagation()">
                <div class="profile-modal-header">
                    <h2>${isGuest ? 'Guest Profile' : 'My Profile'}</h2>
                    <button class="profile-modal-close" onclick="window.profileUI.closeProfileModal()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                
                <div class="profile-modal-body">
                    ${isGuest ? this.createGuestProfileContent(stats) : this.createRegisteredProfileContent(stats)}
                </div>
                
                <div class="profile-modal-footer">
                    ${this.createProfileActions()}
                </div>
            </div>
        `;

        // Add click outside to close
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                this.closeProfileModal();
            }
        });

        return modal;
    }

    createGuestProfileContent(stats) {
        return `
            <div class="profile-guest-content">
                <div class="profile-guest-info">
                    <div class="profile-guest-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </div>
                    <h3>Browse as Guest</h3>
                    <p>You're shopping as a guest. Create an account to save your cart and track orders.</p>
                </div>
                
                <div class="profile-stats-grid">
                    <div class="profile-stat">
                        <div class="profile-stat-value">${stats.cartItems}</div>
                        <div class="profile-stat-label">Cart Items</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-value">${stats.wishlistItems}</div>
                        <div class="profile-stat-label">Wishlist</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-value">$${stats.cartTotal.toFixed(2)}</div>
                        <div class="profile-stat-label">Cart Value</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-value">${this.currentProfile.metadata.visit_count}</div>
                        <div class="profile-stat-label">Visits</div>
                    </div>
                </div>
                
                ${stats.cartItems > 0 ? `
                    <div class="profile-save-reminder">
                        <div class="profile-save-icon">ðŸ’¾</div>
                        <div>
                            <h4>Don't lose your cart!</h4>
                            <p>Create an account to save ${stats.cartItems} item${stats.cartItems !== 1 ? 's' : ''} worth $${stats.cartTotal.toFixed(2)}</p>
                        </div>
                    </div>
                ` : ''}
                
                <div class="profile-activity">
                    <h4>Recent Activity</h4>
                    ${this.createActivityList()}
                </div>
            </div>
        `;
    }

    createRegisteredProfileContent(stats) {
        const profile = this.currentProfile;
        const personalInfo = profile.personal_info || {};
        
        return `
            <div class="profile-registered-content">
                <div class="profile-header-info">
                    <div class="profile-avatar">
                        ${personalInfo.name ? personalInfo.name.charAt(0).toUpperCase() : 'U'}
                    </div>
                    <div class="profile-user-info">
                        <h3>${personalInfo.name || 'User'}</h3>
                        <p>${personalInfo.email || 'No email set'}</p>
                        <small>Member since ${new Date(profile.created_at).toLocaleDateString()}</small>
                    </div>
                </div>
                
                <div class="profile-stats-grid">
                    <div class="profile-stat">
                        <div class="profile-stat-value">${stats.totalOrders}</div>
                        <div class="profile-stat-label">Orders</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-value">$${stats.totalSpent.toFixed(2)}</div>
                        <div class="profile-stat-label">Total Spent</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-value">${stats.cartItems}</div>
                        <div class="profile-stat-label">Cart Items</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-value">${stats.wishlistItems}</div>
                        <div class="profile-stat-label">Wishlist</div>
                    </div>
                </div>
                
                <div class="profile-sections">
                    <div class="profile-section">
                        <h4>Personal Information</h4>
                        <div class="profile-info-item">
                            <label>Name:</label>
                            <span>${personalInfo.name || 'Not set'}</span>
                        </div>
                        <div class="profile-info-item">
                            <label>Email:</label>
                            <span>${personalInfo.email || 'Not set'}</span>
                        </div>
                        <div class="profile-info-item">
                            <label>Phone:</label>
                            <span>${personalInfo.phone || 'Not set'}</span>
                        </div>
                    </div>
                    
                    <div class="profile-section">
                        <h4>Shopping Summary</h4>
                        <div class="profile-info-item">
                            <label>Last Order:</label>
                            <span>${this.getLastOrderDate()}</span>
                        </div>
                        <div class="profile-info-item">
                            <label>Favorite Category:</label>
                            <span>${this.getFavoriteCategory()}</span>
                        </div>
                        <div class="profile-info-item">
                            <label>Cart Value:</label>
                            <span>$${stats.cartTotal.toFixed(2)}</span>
                        </div>
                    </div>
                </div>
                
                <div class="profile-activity">
                    <h4>Recent Activity</h4>
                    ${this.createActivityList()}
                </div>
            </div>
        `;
    }

    createActivityList() {
        const events = this.currentProfile.analytics?.events || [];
        const recentEvents = events.slice(-5).reverse();
        
        if (recentEvents.length === 0) {
            return '<p class="profile-no-activity">No recent activity</p>';
        }
        
        return `
            <div class="profile-activity-list">
                ${recentEvents.map(event => `
                    <div class="profile-activity-item">
                        <div class="profile-activity-icon">${this.getActivityIcon(event.action)}</div>
                        <div class="profile-activity-details">
                            <div class="profile-activity-action">${this.formatActivityAction(event.action)}</div>
                            <div class="profile-activity-time">${this.formatTime(event.timestamp)}</div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    createProfileActions() {
        const isGuest = this.currentProfile.type === 'guest';
        
        if (isGuest) {
            return `
                <div class="profile-actions">
                    <button class="profile-btn profile-btn-primary" onclick="window.profileUI.showSignupPrompt()">
                        Create Account
                    </button>
                    <button class="profile-btn profile-btn-secondary" onclick="window.profileUI.showSignInForm()">
                        Sign In
                    </button>
                    <button class="profile-btn profile-btn-tertiary" onclick="window.profileUI.exportGuestData()">
                        Export Data
                    </button>
                </div>
            `;
        } else {
            return `
                <div class="profile-actions">
                    <button class="profile-btn profile-btn-primary" onclick="window.profileUI.showEditProfile()">
                        Edit Profile
                    </button>
                    <button class="profile-btn profile-btn-secondary" onclick="window.profileUI.showOrderHistory()">
                        Order History
                    </button>
                    <button class="profile-btn profile-btn-tertiary" onclick="window.profileUI.signOut()">
                        Sign Out
                    </button>
                </div>
            `;
        }
    }

    showSignupPrompt() {
        const modal = this.createSignupPromptModal();
        this.modalContainer.appendChild(modal);
        
        setTimeout(() => {
            modal.classList.add('show');
        }, 10);

        if (this.firebaseManager) {
            this.firebaseManager.logEvent('signup_prompt_shown', {
                cart_items: this.currentProfile.shopping?.cart?.items?.length || 0,
                cart_value: this.currentProfile.shopping?.cart?.total || 0
            });
        }
    }

    createSignupPromptModal() {
        const modal = document.createElement('div');
        modal.className = 'signup-prompt-modal';
        modal.id = 'signupPromptModal';
        
        const stats = this.calculateStats();
        
        modal.innerHTML = `
            <div class="signup-prompt-content" onclick="event.stopPropagation()">
                <div class="signup-prompt-header">
                    <h2>Save Your Shopping Progress</h2>
                    <button class="signup-prompt-close" onclick="window.profileUI.closeSignupPrompt()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                
                <div class="signup-prompt-body">
                    <div class="signup-prompt-benefits">
                        <div class="signup-benefit">
                            <div class="benefit-icon">ðŸ›’</div>
                            <div>
                                <h4>Save Your Cart</h4>
                                <p>Keep ${stats.cartItems} item${stats.cartItems !== 1 ? 's' : ''} (${stats.cartTotal.toFixed(2)}) safe</p>
                            </div>
                        </div>
                        <div class="signup-benefit">
                            <div class="benefit-icon">ðŸ“¦</div>
                            <div>
                                <h4>Track Orders</h4>
                                <p>Get updates on your purchases and delivery</p>
                            </div>
                        </div>
                        <div class="signup-benefit">
                            <div class="benefit-icon">â¤ï¸</div>
                            <div>
                                <h4>Wishlist & Favorites</h4>
                                <p>Save items for later and get restock alerts</p>
                            </div>
                        </div>
                        <div class="signup-benefit">
                            <div class="benefit-icon">ðŸŽ¯</div>
                            <div>
                                <h4>Personal Recommendations</h4>
                                <p>Get suggestions based on your browsing</p>
                            </div>
                        </div>
                    </div>
                    
                    <form class="signup-form" onsubmit="window.profileUI.handleSignup(event)">
                        <div class="form-group">
                            <label for="signupName">Full Name</label>
                            <input type="text" id="signupName" name="name" required>
                        </div>
                        <div class="form-group">
                            <label for="signupEmail">Email Address</label>
                            <input type="email" id="signupEmail" name="email" required>
                        </div>
                        <div class="form-group">
                            <label for="signupPhone">Phone (Optional)</label>
                            <input type="tel" id="signupPhone" name="phone">
                        </div>
                        <div class="form-group checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="signupMarketing" name="marketing">
                                <span class="checkmark"></span>
                                Send me style updates and exclusive offers
                            </label>
                        </div>
                        <button type="submit" class="signup-submit-btn">Create Free Account</button>
                    </form>
                </div>
            </div>
        `;

        // Add click outside to close
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                this.closeSignupPrompt();
            }
        });

        return modal;
    }

    async handleSignup(event) {
        event.preventDefault();
        
        const formData = new FormData(event.target);
        const userData = {
            name: formData.get('name'),
            email: formData.get('email'),
            phone: formData.get('phone') || null,
            marketing_emails: formData.get('marketing') === 'on'
        };

        try {
            const submitBtn = event.target.querySelector('.signup-submit-btn');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Creating Account...';
            submitBtn.disabled = true;

            // Update profile with user information
            await this.firebaseManager.updateProfile({
                personal_info: userData,
                preferences: {
                    marketing_emails: userData.marketing_emails
                }
            });

            // Log conversion
            await this.firebaseManager.logEvent('guest_converted_to_user', {
                cart_items: this.currentProfile.shopping?.cart?.items?.length || 0,
                cart_value: this.currentProfile.shopping?.cart?.total || 0,
                marketing_opt_in: userData.marketing_emails
            });

            // Reload profile
            await this.loadProfile();

            // Show success message
            this.showSuccessMessage('Account created successfully! Your cart and preferences have been saved.');
            
            // Close modals
            this.closeAllModals();
            
        } catch (error) {
            console.error('Signup failed:', error);
            this.showErrorMessage('Failed to create account. Please try again.');
            
            const submitBtn = event.target.querySelector('.signup-submit-btn');
            submitBtn.textContent = 'Create Free Account';
            submitBtn.disabled = false;
        }
    }

    showSignInForm() {
        // For demo purposes, show a simple alert
        // In production, implement full authentication
        alert('Sign In functionality would be implemented here with full Firebase Authentication.');
    }

    async exportGuestData() {
        try {
            const exportData = await this.firebaseManager.exportProfileData();
            
            if (exportData) {
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `profile-data-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                this.showSuccessMessage('Profile data exported successfully!');
            }
        } catch (error) {
            console.error('Export failed:', error);
            this.showErrorMessage('Failed to export data.');
        }
    }

    showEditProfile() {
        // Create edit profile modal
        const modal = this.createEditProfileModal();
        this.modalContainer.appendChild(modal);
        
        setTimeout(() => {
            modal.classList.add('show');
        }, 10);
    }

    createEditProfileModal() {
        const modal = document.createElement('div');
        modal.className = 'profile-modal';
        modal.id = 'editProfileModal';
        
        const personalInfo = this.currentProfile.personal_info || {};
        const preferences = this.currentProfile.preferences || {};
        
        modal.innerHTML = `
            <div class="profile-modal-content" onclick="event.stopPropagation()">
                <div class="profile-modal-header">
                    <h2>Edit Profile</h2>
                    <button class="profile-modal-close" onclick="window.profileUI.closeEditProfile()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                
                <div class="profile-modal-body">
                    <form class="edit-profile-form" onsubmit="window.profileUI.handleProfileUpdate(event)">
                        <div class="form-section">
                            <h4>Personal Information</h4>
                            <div class="form-group">
                                <label for="editName">Full Name</label>
                                <input type="text" id="editName" name="name" value="${personalInfo.name || ''}" required>
                            </div>
                            <div class="form-group">
                                <label for="editEmail">Email Address</label>
                                <input type="email" id="editEmail" name="email" value="${personalInfo.email || ''}" required>
                            </div>
                            <div class="form-group">
                                <label for="editPhone">Phone Number</label>
                                <input type="tel" id="editPhone" name="phone" value="${personalInfo.phone || ''}">
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h4>Preferences</h4>
                            <div class="form-group checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="notifications" ${preferences.notifications ? 'checked' : ''}>
                                    <span class="checkmark"></span>
                                    Email notifications
                                </label>
                            </div>
                            <div class="form-group checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="marketing_emails" ${preferences.marketing_emails ? 'checked' : ''}>
                                    <span class="checkmark"></span>
                                    Marketing emails and offers
                                </label>
                            </div>
                            <div class="form-group">
                                <label for="editCurrency">Preferred Currency</label>
                                <select id="editCurrency" name="currency">
                                    <option value="USD" ${preferences.currency === 'USD' ? 'selected' : ''}>USD ($)</option>
                                    <option value="EUR" ${preferences.currency === 'EUR' ? 'selected' : ''}>EUR (â‚¬)</option>
                                    <option value="GBP" ${preferences.currency === 'GBP' ? 'selected' : ''}>GBP (Â£)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="profile-btn profile-btn-secondary" onclick="window.profileUI.closeEditProfile()">
                                Cancel
                            </button>
                            <button type="submit" class="profile-btn profile-btn-primary">
                                Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                this.closeEditProfile();
            }
        });

        return modal;
    }

    async handleProfileUpdate(event) {
        event.preventDefault();
        
        const formData = new FormData(event.target);
        const updates = {
            personal_info: {
                name: formData.get('name'),
                email: formData.get('email'),
                phone: formData.get('phone') || null
            },
            preferences: {
                notifications: formData.get('notifications') === 'on',
                marketing_emails: formData.get('marketing_emails') === 'on',
                currency: formData.get('currency')
            }
        };

        try {
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Saving...';
            submitBtn.disabled = true;

            await this.firebaseManager.updateProfile(updates);
            await this.loadProfile();

            this.showSuccessMessage('Profile updated successfully!');
            this.closeEditProfile();
            
        } catch (error) {
            console.error('Profile update failed:', error);
            this.showErrorMessage('Failed to update profile. Please try again.');
            
            const submitBtn = event.target.querySelector('button[type="submit"]');
            submitBtn.textContent = 'Save Changes';
            submitBtn.disabled = false;
        }
    }

    showOrderHistory() {
        const orders = this.currentProfile.shopping?.purchase_history || [];
        
        if (orders.length === 0) {
            alert('No order history found. Start shopping to see your orders here!');
            return;
        }

        // For demo purposes, show a simple alert with order count
        // In production, create a full order history modal
        alert(`Order History:\n\nTotal Orders: ${orders.length}\nTotal Spent: ${orders.reduce((sum, order) => sum + (order.totals?.total || 0), 0).toFixed(2)}\n\nFull order history interface would be implemented here.`);
    }

    async signOut() {
        try {
            if (this.firebaseManager.signOutUser) {
                await this.firebaseManager.signOutUser();
            }
            
            // Clear profile and reload
            this.currentProfile = await this.firebaseManager.getCurrentProfile();
            this.updateProfileButton();
            this.closeAllModals();
            
            this.showSuccessMessage('Signed out successfully.');
            
        } catch (error) {
            console.error('Sign out failed:', error);
            this.showErrorMessage('Failed to sign out.');
        }
    }

    // Utility methods
    calculateStats() {
        if (!this.currentProfile) return { totalOrders: 0, totalSpent: 0, cartItems: 0, wishlistItems: 0, cartTotal: 0 };

        const shopping = this.currentProfile.shopping || {};
        const totalOrders = shopping.purchase_history?.length || 0;
        const totalSpent = shopping.purchase_history?.reduce((sum, order) => sum + (order.totals?.total || 0), 0) || 0;
        const cartItems = shopping.cart?.items?.length || 0;
        const wishlistItems = shopping.wishlist?.length || 0;
        const cartTotal = shopping.cart?.total || 0;

        return { totalOrders, totalSpent, cartItems, wishlistItems, cartTotal };
    }

    getLastOrderDate() {
        const orders = this.currentProfile.shopping?.purchase_history || [];
        if (orders.length === 0) return 'No orders yet';
        
        const lastOrder = orders[orders.length - 1];
        return new Date(lastOrder.purchased_at).toLocaleDateString();
    }

    getFavoriteCategory() {
        const productViews = this.currentProfile.browsing?.product_views || [];
        if (productViews.length === 0) return 'None yet';
        
        const categories = {};
        productViews.forEach(view => {
            const category = view.product_data?.category;
            if (category) {
                categories[category] = (categories[category] || 0) + 1;
            }
        });
        
        const sortedCategories = Object.entries(categories).sort(([,a], [,b]) => b - a);
        return sortedCategories.length > 0 ? this.formatCategoryName(sortedCategories[0][0]) : 'None yet';
    }

    formatCategoryName(category) {
        const names = {
            'boys': 'Boys Clothing',
            'girls': 'Girls Clothing',
            'women': 'Women\'s Jewelry',
            'accessories': 'Accessories'
        };
        return names[category] || category;
    }

    getActivityIcon(action) {
        const icons = {
            'item_added_to_cart': 'ðŸ›’',
            'item_removed_from_cart': 'ðŸ—‘ï¸',
            'cart_quantity_updated': 'ðŸ“',
            'page_view': 'ðŸ‘€',
            'product_view': 'ðŸ”',
            'filter_used': 'ðŸ”§',
            'checkout_initiated': 'ðŸ’³',
            'default': 'ðŸ“‹'
        };
        return icons[action] || icons.default;
    }

    formatActivityAction(action) {
        const labels = {
            'item_added_to_cart': 'Added item to cart',
            'item_removed_from_cart': 'Removed item from cart',
            'cart_quantity_updated': 'Updated cart quantity',
            'page_view': 'Viewed page',
            'product_view': 'Viewed product',
            'filter_used': 'Used filter',
            'checkout_initiated': 'Started checkout'
        };
        return labels[action] || action.replace(/_/g, ' ');
    }

    formatTime(timestamp) {
        const now = new Date();
        const time = new Date(timestamp);
        const diff = now - time;
        
        if (diff < 60000) return 'Just now';
        if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
        if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
        return `${Math.floor(diff / 86400000)}d ago`;
    }

    showSuccessMessage(message) {
        this.showMessage(message, 'success');
    }

    showErrorMessage(message) {
        this.showMessage(message, 'error');
    }

    showMessage(message, type = 'success') {
        // Use existing notification system
        if (window.showNotification) {
            window.showNotification(message, type);
        } else {
            alert(message);
        }
    }

    // Modal management
    closeProfileModal() {
        const modal = document.getElementById('profileModal');
        if (modal) {
            modal.classList.remove('show');
            setTimeout(() => {
                modal.remove();
            }, 300);
        }
    }

    closeSignupPrompt() {
        const modal = document.getElementById('signupPromptModal');
        if (modal) {
            modal.classList.remove('show');
            setTimeout(() => {
                modal.remove();
            }, 300);
        }
    }

    closeEditProfile() {
        const modal = document.getElementById('editProfileModal');
        if (modal) {
            modal.classList.remove('show');
            setTimeout(() => {
                modal.remove();
            }, 300);
        }
    }

    closeAllModals() {
        this.closeProfileModal();
        this.closeSignupPrompt();
        this.closeEditProfile();
    }
}
    </script>
    <script src="firebase-manager.js"></script>
    <script src="script.js"></script>
</body>
</html>